graph:
  id: "graph_new_flow"
  description: "Proceso new_flow."

  nodes:
    - id: "start"
      action: "send_message"
      message: "$LINDEN_INTRODUCTION_MESSAGE"
      next: "AWAITING_MESSAGE"
    - id: "AWAITING_MESSAGE"
      next: "AWAITING_USER_DATA"
    - id: "AWAITING_USER_DATA"
      action: "use_special_function"
      function_name: "send_user_data_form"
      decision:
        state: "AWAITING_USER_DATA"
        form-completed: "ANALYZING_INTENT"
    - id: "ANALYZING_INTENT"
      action: "use_tools"
      tools:
        - name: "analyze_intent"
          type: "enum"
          options:
            - "is_emergency"
            - "is_potential_patient"
            - "is_question_about_condition"
            - "is_question_event"
            - "is_frequently_asked_question"
            - "is_out_of_scope_question"
            - "is_frustrated_needs_human"
            - "is_acknowledgment"
      decision:
        state: "ANALYZING_INTENT"
        analyze_intent:_is_emergency: "INVALID_REQUEST_EMERGENCY"
        analyze_intent:_is_potential_patient: "INTENT_POTENTIAL_PATIENT"
        analyze_intent:_is_question_about_condition: "INTENT_QUESTION_CONDITION"
        analyze_intent:_is_frequently_asked_question: "INTENT_FAQ"
        analyze_intent:_is_frustrated_needs_human: "INTENT_FRUSTRATED_CUSTOMER"
        analyze_intent:_is_acknowledgment: "CUSTOMER_ACKNOWLEDGES_RESPONSE"
        analyze_intent:_is_question_event: "INTENT_EVENT_QUESTION"
        analyze_intent:_is_out_of_scope_question: "INTENT_OUT_OF_SCOPE_QUESTION"
    - id: "INTENT_QUESTION_CONDITION"
      action: "use_special_function"
      function_name: "send_information_about_condition"
      next: "PROVIDED_CONDITION_INFORMATION"
    - id: "INTENT_POTENTIAL_PATIENT"
      action: "use_tools"
      tools:
        - name: "is_condition_treated"
          type: "boolean-toggle"
      decision:
        state: "INTENT_POTENTIAL_PATIENT"
        is_condition_treated:_false: "CONDITION_NOT_TREATED_SEND_CONTACT_INFO"
        is_condition_treated:_true: "CONDITION_IS_TREATED"
    - id: "PROVIDED_CONDITION_INFORMATION"
      action: "use_special_function"
      function_name: "send_information_about_condition"
      next: "RECOMMENDED_DOCTOR"
    - id: "INTENT_FRUSTRATED_CUSTOMER"
      action: "send_message"
      message: "$PROMPT_FRUSTRATED_CUSTOMER_OFFER_BOOK_CALL"
      decision:
        state: "INTENT_FRUSTRATED_CUSTOMER"
        book_call_offered_already: "CONVERSATION_FINISHED"
        book_call_not_offered_yet: "BOOK_CALL_NOT_OFFERED_YET"
    - id: "CONDITION_IS_TREATED"
      decision:
        state: "CONDITION_IS_TREATED"
        book_call_offered_already: "CONVERSATION_FINISHED"
        book_call_not_offered_yet: "BOOK_CALL_NOT_OFFERED_YET"
    - id: "INTENT_FAQ"
      action: "use_tools"
      tools:
        - name: "is_question_insurance"
          type: "boolean-flag"
        - name: "is_service_pricey"
          type: "boolean-flag"
        - name: "is_question_in_person"
          type: "boolean-flag"
        - name: "is_question_location"
          type: "boolean-flag"
      decision:
        state: "INTENT_FAQ"
        is_question_insurance:_true: "ANSWER_QUESTION_INSURANCE"
        is_question_in_person:_true: "ANSWER_QUESTION_IN_PERSON"
        is_question_location:_true: "ANSWER_QUESTION_LOCATION"
        is_service_pricey:_true: "ANSWER_QUESTION_PRICEY_SERVICE"
    - id: "CUSTOMER_ACKNOWLEDGES_RESPONSE"
      action: "send_message"
      message: "$ACKNOWLEDGMENT_MESSAGE"
      decision:
        state: "CUSTOMER_ACKNOWLEDGES_RESPONSE"
        book_call_offered_already: "CONVERSATION_FINISHED"
        book_call_not_offered_yet: "BOOK_CALL_NOT_OFFERED_YET"
    - id: "INTENT_OUT_OF_SCOPE_QUESTION"
      decision:
        state: "INTENT_OUT_OF_SCOPE_QUESTION"
        book_call_offered_already: "CONVERSATION_FINISHED"
        book_call_not_offered_yet: "BOOK_CALL_NOT_OFFERED_YET"
    - id: "RECOMMENDED_DOCTOR"
      action: "use_special_function"
      function_name: "send_doctor_information"
      decision:
        state: "RECOMMENDED_DOCTOR"
        book_call_offered_already: "CONVERSATION_FINISHED"
        book_call_not_offered_yet: "BOOK_CALL_NOT_OFFERED_YET"
    - id: "ANSWER_QUESTION_INSURANCE"
      action: "send_message"
      message: "$PROMPT_QUESTION_INSURANCE"
      next: "PROVIDED_FAQ_INFORMATION"
    - id: "ANSWER_QUESTION_IN_PERSON"
      action: "send_message"
      message: "$PROMPT_QUESTION_IN_PERSON"
      next: "PROVIDED_FAQ_INFORMATION"
    - id: "ANSWER_QUESTION_LOCATION"
      next: "ASKED_STATE"
    - id: "ANSWER_QUESTION_PRICEY_SERVICE"
      action: "send_message"
      message: "$PROMPT_QUESTION_PRICEY_SERVICE"
      next: "PROVIDED_FAQ_INFORMATION"
    - id: "BOOK_CALL_NOT_OFFERED_YET"
      action: "send_message"
      message: "$PROMPT_ASK_STATE"
      next: "ASKED_STATE"
    - id: "CONDITION_NOT_TREATED_SEND_CONTACT_INFO"
      action: "send_message"
      message: "$PROMPT_CONDITION_NOT_TREATED"
      next: "REQUEST_RESOLVED_AWAIT_NEW_MESSAGE"
    - id: "PROVIDED_FAQ_INFORMATION"
      action: "use_special_function"
      function_name: "send_faq_information"
      next: "REQUEST_RESOLVED_AWAIT_NEW_MESSAGE"
    - id: "INVALID_REQUEST_EMERGENCY"
      action: "send_message"
      message: "$OUTPUT_MESSAGE_EMERGENCY"
      next: "REQUEST_RESOLVED_AWAIT_NEW_MESSAGE"
    - id: "ASKED_STATE"
      action: "use_tools"
      tools:
        - name: "is_valid_state"
          type: "boolean-toggle"
      decision:
        state: "ASKED_STATE"
        is_valid_state:_true: "OFFER_BOOK_CALL"
        is_valid_state:_false: "REQUEST_RESOLVED_AWAIT_NEW_MESSAGE"
    - id: "INTENT_EVENT_QUESTION"
      action: "use_special_function"
      function_name: "send_event_information"
      next: "REQUEST_RESOLVED_AWAIT_NEW_MESSAGE"
    - id: "OFFER_BOOK_CALL"
      action: "send_message"
      message: "$PROMPT_OFFER_BOOK_CALL"
      next: "SENT_BOOK_CALL_OFFER"
    - id: "REQUEST_RESOLVED_AWAIT_NEW_MESSAGE"
      next: "ANALYZING_INTENT"
    - id: "SENT_BOOK_CALL_OFFER"
      action: "use_tools"
      tools:
        - name: "user_accepts_book_call"
          type: "boolean-toggle"
      decision:
        state: "SENT_BOOK_CALL_OFFER"
        user_accepts_book_call:_true: "BOOK_CALL_LINK_SENT"
        user_accepts_book_call:_false: "BOOK_CALL_OFFER_DECLINED"
    - id: "BOOK_CALL_LINK_SENT"
      action: "use_special_function"
      function_name: "send_book_call_link"
      next: "CONVERSATION_FINISHED"
    - id: "BOOK_CALL_OFFER_DECLINED"
      action: "send_message"
      message: "$PROMPT_PROVIDE_CONTACT_INFO"
      next: "CONVERSATION_FINISHED"
    - id: "CONVERSATION_FINISHED"
      action: "send_message"
      message: "$PROMPT_OFFER_NEWSLETTER"
      decision:
        state: "CONVERSATION_FINISHED"
        yes: "MAILING_LIST_OFFER_ACCEPTED"
        no: "end"
    - id: "MAILING_LIST_OFFER_ACCEPTED"
      action: "use_special_function"
      function_name: "save_to_mailing_list"
      next: "end"
    - id: "end"
